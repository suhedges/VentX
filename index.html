<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VentX â€“ Phone Stock Manager</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico">

<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  THEME  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  /* --- NEW core palette --- */
  --bg-dark:#0f172a;            /* page background                */
  --surface-dark:#1f2937;       /* cards, dialogs, table rows â€¦   */

  /* --- accent palette (kept the same names) --- */
  --blue:#3b82f6;
  --blue-hover:#2563eb;

  /* --- neutrals & text --- */
  --gray:var(--surface-dark);   /* was #1f2937                     */
  --light:var(--bg-dark);       /* replaces the old light gray     */
  --border-dark:#334155;        /* slate-700                       */
  --text:#f8fafc;               /* very light text                 */

  --radius:8px;
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif
}
*{box-sizing:border-box;margin:0;padding:0}
body,html{height:100%}
body{
  display:flex;flex-direction:column;
  background:var(--bg-dark);
  color:var(--text)
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SHARED  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
button{
  --bg:#374151;        /* default button background (slate-700) */
  --fg:var(--text);
  border:none;border-radius:6px;padding:.55rem 1.05rem;
  font-size:1rem;cursor:pointer;line-height:1.2;
  display:inline-flex;align-items:center;gap:.45rem;
  background:var(--bg);color:var(--fg);justify-content:center;
  transition:
    background .2s ease,
    box-shadow .25s ease,
    transform .18s ease;
  position:relative;overflow:hidden              /* for ripple */
}
button img{width:18px;height:18px;filter:invert(1)}
button:active{transform:translateY(1px) scale(.98)}
button:hover{box-shadow:0 6px 18px #0006;transform:translateY(-2px) scale(1.03)}
#addUserBtn{display:none}
#delUserBtn{display:none}
#installBtn{display:none}
/* ripple animation */
button::after{
  content:"";position:absolute;inset:0;
  background:radial-gradient(circle at center, #ffffff44 10%, transparent 60%);
  opacity:0;transform:scale(0);transition:opacity .6s,transform .6s
}
button:active::after{opacity:.35;transform:scale(2.5);transition:0s}

.pri{--bg:var(--blue);--fg:#fff}
.pri:hover{background:var(--blue-hover)}
.sec:hover{background:#475569}

/* modernize inputs & selects */
input,select{
  width:100%;padding:.5rem .75rem;
  border:1px solid var(--border-dark);border-radius:6px;font-size:1rem;
  background:var(--surface-dark);color:var(--text)
}
label{display:flex;flex-direction:column;gap:.25rem;font-weight:600}

/* username always upper-case */
#l_user{text-transform:uppercase}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  TOGGLE  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle{
  display:inline-flex;align-items:center;gap:.4rem;
  font-size:.95rem;font-weight:500;cursor:pointer
}
.toggle input{
  appearance:none;width:42px;height:24px;border-radius:12px;
  background:#475569;outline:none;position:relative;transition:background .2s
}
.toggle input::before{
  content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;
  border-radius:50%;background:#fff;transition:transform .2s
}
.toggle input:checked{background:var(--blue)}
.toggle input:checked::before{transform:translateX(18px)}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  DIALOGS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
dialog{
  border:none;border-radius:var(--radius);padding:1rem;width:92%;max-width:480px;
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:var(--surface-dark);color:var(--text);
  box-shadow:0 6px 24px #000a
}
dialog::backdrop{background:#0008}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SCREENS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen{flex:1;display:none;flex-direction:column}
.show{display:flex}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  LOGIN  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login form{
  margin:auto;width:90%;max-width:380px;border:1px solid var(--border-dark);
  padding:2rem;border-radius:var(--radius);
  background:var(--surface-dark);box-shadow:0 4px 18px #0008
}
#login h2{margin-bottom:1rem;text-align:center}
#installBtn{margin-top:.6rem;width:100%}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  WAREHOUSES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#wh header{background:var(--gray);color:var(--text);padding:.9rem 1.2rem;font-size:1.3rem}
#wh ul{list-style:none;padding:1rem;gap:.7rem;display:flex;flex-direction:column}
#wh li{
  padding:.8rem 1rem;border:1px solid var(--border-dark);border-radius:8px;
  display:flex;justify-content:space-between;align-items:center;
  background:var(--surface-dark);color:var(--text);
  box-shadow:0 2px 4px #0004;cursor:pointer;user-select:none;
  transition:background .2s
}
#wh li:hover{background:#273449}
#wh li .actions{display:flex;gap:.4rem}
#wh li button{pointer-events:auto}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  MAIN  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main header{
  display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;
  background:var(--gray);color:var(--text);padding:.8rem 1rem
}
#main header input{max-width:220px}
#main header input{background:var(--surface-dark);color:var(--text)}
#main header span{margin-left:auto;font-weight:500}
#delSel{display:none}

/* -- compact actions menu (hamburger) -- */
.menu-wrap{position:relative}
#menuToggle img{width:22px;height:22px;filter:invert(1)}
#menu{
  position:absolute;top:110%;left:0;background:var(--surface-dark);color:var(--text);
  border:1px solid var(--border-dark);border-radius:6px;box-shadow:0 4px 12px #0006;
  display:none;flex-direction:column;min-width:180px;z-index:50
}
#menu.show{display:flex}
#menu button{justify-content:flex-start;width:100%;border-radius:0;background:transparent}
#menu button:hover{background:#273449}

/* -- items table wrapper -- */
#itemsWrap{flex:1;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{
  padding:.55rem .8rem;border-bottom:1px solid var(--border-dark);
  text-align:left;white-space:nowrap
}
tbody tr:hover{background:#273449;cursor:pointer}
th{
  background:#1e293b;position:sticky;top:0;z-index:1;cursor:pointer;user-select:none;
  color:var(--text)
}
th.sort-asc::after{content:" â–²";font-size:.75rem}
th.sort-desc::after{content:" â–¼";font-size:.75rem}
td.qty{text-align:right;font-weight:600}
td.qty[contenteditable]:focus{outline:2px solid var(--blue)}
th.chk,td.chk{width:42px;text-align:center}
.row-del{cursor:pointer;filter:invert(1)}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  FAB  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#fab{
  position:fixed;right:1.2rem;bottom:1.2rem;width:60px;height:60px;
  background:var(--blue);color:#fff;border:none;border-radius:50%;
  display:flex;justify-content:center;align-items:center;
  box-shadow:0 6px 16px #000a;transition:transform .25s
}
#fab img{width:28px;height:28px;filter:invert(1)}
#fab:hover{transform:scale(1.08)}
#fab:active{transform:scale(.95);transition:transform .05s}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SCAN DIALOG  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#scanDlg{
  overflow:hidden;max-height:90vh;
}
#scanDlg video{
  width:100%;height:auto;max-height:60vh;
  object-fit:contain;display:block;border-radius:var(--radius);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  MOBILE OVERRIDES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  #main header{flex-direction:column;align-items:stretch}
  #main header > *{width:100%;max-width:100%}
  #menu{left:20%}
  #menuToggle{align-self:flex-end;width:100%}
  #searchInput{margin:0 auto}

  .mobile-sort{display:block;margin:.4rem 0}

  /* responsive table â†’ stacked cards */
  table{min-width:0}
  thead{display:none}
  tbody tr{display:block;border:1px solid var(--border-dark);margin:.65rem 0;border-radius:6px}
  tbody td{
    display:flex;justify-content:space-between;align-items:center;
    padding:.65rem .8rem;border:none;white-space:normal
  }
  tbody td::before{
    content:attr(data-key);
    font-weight:600;color:var(--text-muted);text-transform:capitalize
  }
  td.chk{display:none}
  td.qty{text-align:left}
}
/* desktop-only mobile-sort hidden */
@media(min-width:641px){
  .mobile-sort{display:none}
}
/* end media */
</style>
</head>
<body>
<!--â€‘â€‘â€‘â€‘â€‘ LOGIN â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘-->
<section id="login" class="screen show">
  <form id="loginForm">
    <h2>Login</h2>
    <label>Username <input id="l_user" required autocomplete="username"></label>

    <button class="pri" style="margin-top:1.6rem;width:100%">Sign in</button>

    <div style="display:flex;gap:.5rem;margin-top:.6rem">
      <button id="addUserBtn" class="sec" style="flex:1">Add&nbsp;User</button>
      <button id="delUserBtn" class="sec" style="flex:1">Remove&nbsp;User</button>
    </div>
    <button id="installBtn" class="sec">Install&nbsp;App</button>
  </form>
</section>

<!--â€‘â€‘â€‘â€‘â€‘ WAREHOUSES â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘-->
<section id="wh" class="screen">
  <header>Warehouses</header>
  <ul id="whList"></ul>
  <div style="display:flex;gap:.6rem;margin:1rem;justify-content:center;">
    <button id="addWh"      class="pri">ï¼‹ Add Warehouse</button>
    <button id="uploadBtnWH" class="sec">Upload Backup</button>
    <button id="downloadBtnWH" class="sec">Download Backup</button>
  </div>
</section>

<!--â€‘â€‘â€‘â€‘â€‘ MAIN â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘-->
<section id="main" class="screen">
  <header>
    <button id="backWh" class="sec">
      <img src="circle-left-regular.svg" alt="" /> Warehouses
    </button>

    <!-- compact actions menu -->
    <div class="menu-wrap">
      <button id="menuToggle" class="sec" title="Actions">
        <img src="burger-solid.svg" alt="Menu">
      </button>
      <div id="menu" class="dropdown">
        <button id="impBtn"  class="sec">
          <img src="download-solid.svg" style="opacity:.7" alt=""> Import
        </button>
        <button id="tmplBtn" class="sec">
          <img src="download-solid.svg" style="opacity:.7" alt=""> Download&nbsp;Template
        </button>
        <button id="downloadBtn" class="sec">
          <img src="download-solid.svg" alt=""> Download&nbsp;Backup
        </button>
      </div>
    </div>

    <button id="uploadBtn" class="sec">
      <img src="cloud-arrow-up-solid.svg" alt=""> Upload
    </button>
    <button id="exportBtn" class="sec">
      <img src="file-export-solid.svg" alt=""> Export
    </button>
    <button id="massUPCBtn" class="sec">
      <img src="barcode-solid.svg" alt=""> Mass&nbsp;UPC
    </button>
    <button id="delSel" class="sec">
      <img src="trash-solid.svg" alt=""> Delete&nbsp;Selected
    </button>

    <!-- search / filters -->
    <input id="searchInput" placeholder="Searchâ€¦">
    <label class="toggle" title="Show only items at/below Min">
      <input type="checkbox" id="belowToggle">
      <span>Below&nbsp;Min</span>
    </label>

    <select id="sortSelect" class="mobile-sort"></select>
    <span id="count"></span>
  </header>

  <div id="itemsWrap">
    <table id="itemsTable">
      <thead>
        <tr>
          <th class="chk"><input type="checkbox" id="selectAll"></th>
          <th data-key="internal">TSB#</th>
          <th data-key="custom">CustPN</th>
          <th data-key="upc">UPC</th>
          <th data-key="min">Min</th>
          <th data-key="max">Max</th>
          <th data-key="qty">Qty</th>
          <th data-key="bin">BIN</th>
          <th class="chk"></th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <button id="fab" title="Scan product">
    <img src="camera-solid.svg" alt="Scan">
  </button>
</section>

<!--â€‘â€‘â€‘â€‘â€‘ SCAN DIALOG â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘-->
<dialog id="scanDlg">
  <h4 id="scanInfo" style="text-align:center"></h4>
  <video id="cam" playsinline></video>
  <p align="center">Point camera at barcodeâ€¦</p>
  <button class="sec" id="scanCancel" style="width:100%">Cancel</button>
</dialog>

<!--â€‘â€‘â€‘â€‘â€‘ PRODUCT MANAGER â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘-->
<dialog id="prodDlg">
  <form id="prodForm" novalidate>
    <h3 id="hdr">Add / Edit Item</h3>

    <label class="full">Internal&nbsp;Part <input id="p_internal" required></label>
    <label class="full">Custom&nbsp;Part   <input id="p_custom"></label>

    <label class="full">UPC
      <div class="row">
        <input id="p_upc">
        <button type="button" class="sec" id="btnUPC">
          <img src="camera-solid.svg" alt="" style="opacity:.7"> Scan&nbsp;UPC
        </button>
      </div>
    </label>

    <label>Qty <input id="p_qty" type="number" required></label>
    <label>Min <input id="p_min" type="number" required></label>
    <label>Max <input id="p_max" type="number" required></label>
    <label class="full">Bin <input id="p_bin"></label>

    <div class="actions">
      <button type="button" class="sec" id="closeProd">Close</button>
      <button class="pri">Save</button>
    </div>
  </form>
</dialog>

<!--â€‘â€‘â€‘â€‘â€‘ EXPORT DIALOG  â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘-->
<dialog id="exportDlg">
  <h4>Export Inventory</h4>
  <button id="expAll" class="pri">Export ALL Items</button>
  <button id="expLow" class="sec">Export Items Below Min</button>
  <button id="expCancel" class="sec">Cancel</button>
</dialog>

<!--â€‘â€‘â€‘â€‘â€‘ FILE IMPORT INPUT (hidden) â€‘â€‘â€‘â€‘â€‘â€‘â€‘â€‘-->
<input id="importFile" type="file" accept=".csv,.xlsx,.xls" hidden>

<script type="module">

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DOM REFERENCES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const $ = id => document.getElementById(id);
const downloadBtn=$('downloadBtn'),       downloadBtnWH=$('downloadBtnWH');
const exportBtn=$('exportBtn'), exportDlg=$('exportDlg'), expAll=$('expAll'), expLow=$('expLow'), expCancel=$('expCancel');
const belowToggle=$('belowToggle');
const scanDlg=$('scanDlg'), scanCancel=$('scanCancel'), cam=$('cam');
const fab=$('fab'), impBtn=$('impBtn'), tmplBtn=$('tmplBtn'), importFile=$('importFile');
const loginForm=$('loginForm'), l_user=$('l_user'), installBtn=$('installBtn');
const addUserBtn=$('addUserBtn'), delUserBtn=$('delUserBtn');
const whList=$('whList'), addWh=$('addWh');
const p_internal=$('p_internal'), p_custom=$('p_custom'), p_upc=$('p_upc');
const p_qty=$('p_qty'), p_min=$('p_min'), p_max=$('p_max'), p_bin=$('p_bin');
const hdr=$('hdr'), prodDlg=$('prodDlg'), prodForm=$('prodForm');
const closeProd=$('closeProd'), btnUPC=$('btnUPC');
const backWh=$('backWh'), itemsBody=$('itemsBody'), count=$('count');
const searchInput=$('searchInput'), uploadBtn=$('uploadBtn'), uploadBtnWH=$('uploadBtnWH');
const thead = $('itemsTable').querySelector('thead');
const selectAll=$('selectAll'), delSel=$('delSel');
const massUPCBtn=$('massUPCBtn'), scanInfo=$('scanInfo');
const menuToggle=$('menuToggle'), menu=$('menu');
const sortSelect=$('sortSelect');

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  INPUT â†’ ALWAYS UPPERCASE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
l_user.addEventListener('input', ()=>{ l_user.value = l_user.value.toUpperCase(); });

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  HAMBURGER MENU TOGGLE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
menuToggle.onclick = e =>{
  e.stopPropagation();
  menu.classList.toggle('show');
};
/* close menu on outside click */
document.addEventListener('click', e=>{
  if(!menu.contains(e.target) && !menuToggle.contains(e.target))
    menu.classList.remove('show');
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  MOBILE SORTâ€‘BY SELECT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const SORT_FIELDS = [
  ['internal','TSB#'],['custom','CustPN'],['upc','UPC'],
  ['min','Min'],['max','Max'],['qty','Qty'],['bin','BIN']
];
function buildSortSelect(){
  sortSelect.innerHTML = SORT_FIELDS.flatMap(([key,label])=>[
    `<option value="${key}|asc">${label} â†‘</option>`,
    `<option value="${key}|desc">${label} â†“</option>`
  ]).join('');
}
buildSortSelect();
sortSelect.onchange = ()=>{
  [sortField,sortDir] = sortSelect.value.split('|');
  thead.querySelectorAll('th').forEach(th=>th.classList.remove('sort-asc','sort-desc'));
  const th=thead.querySelector(`th[data-key="${sortField}"]`);
  th?.classList.add(sortDir==='asc'?'sort-asc':'sort-desc');
  render();
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  WAREHOUSE LIST CLICKABLE  (Open on <li>)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
whList.onclick = e=>{
  const li = e.target.closest('li[data-wh]');
  if(!li || e.target.closest('button')) return;     // ignore clicks on action buttons
  const id   = +li.dataset.wh;
  const name = li.dataset.name;
  openWh(id,name);
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DOWNLOAD BACKUP BUTTON (WAREHOUSE VIEW)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
downloadBtnWH.onclick = downloadBackup;

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  EXTERNAL LIBS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';
import {
  BrowserMultiFormatReader,
  DecodeHintType,
  BarcodeFormat
} from 'https://cdn.skypack.dev/@zxing/library@0.20.0';

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CONSTANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const APP_VERSION = '2025-07-15';

/* -------------- PAT HANDLING --------------
   Leave blank; youâ€™ll be prompted once,
   then token is cached in localStorage.
-------------------------------------------*/
const HARD_TOKEN = [
  'gh','p_DI','B459','Q4L8','p9QJ','tlJx','uDHn','8jW9','eb2r','1u4E','mu'
].join('');

let sortField='internal', sortDir='asc';
thead.addEventListener('click', e=>{
  const th=e.target.closest('th[data-key]'); if(!th) return;
  const key=th.dataset.key;
  if(sortField===key){ sortDir=sortDir==='asc'?'desc':'asc'; }
  else{ sortField=key; sortDir='asc'; }
  thead.querySelectorAll('th').forEach(th=>th.classList.remove('sort-asc','sort-desc'));
  th.classList.add(sortDir==='asc'?'sort-asc':'sort-desc');
  render();
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  STATE HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let user=null, whId=null, whName=null, current=null, deferredPrompt=null;
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.toggle('show',s.id===id));}

/* MASS UPC STATE */
let massMode=false, massList=[], massIndex=0;

/* SELECTION STATE */
const selectedParts=new Set();

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  INDEXED-DB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const db = await openDB('inventory', 4, {
  upgrade(db, oldVersion){
    if(oldVersion<1 && !db.objectStoreNames.contains('users'))
      db.createObjectStore('users',{keyPath:'name'});
    if(oldVersion<2 && !db.objectStoreNames.contains('warehouses'))
      db.createObjectStore('warehouses',{keyPath:'id',autoIncrement:true});
    if(oldVersion<3 && !db.objectStoreNames.contains('items'))
      db.createObjectStore('items',{keyPath:'key'});
    if(oldVersion<4 && !db.objectStoreNames.contains('logs'))
      db.createObjectStore('logs',{keyPath:'ts'});
  }
});
await navigator.storage?.persist?.();

/* seed demo users */
for(const u of ['US1','US2'])
  if(!(await db.get('users',u))) db.put('users',{name:u});

/* simple logger */
async function logError(type,msg){
  try{ await db.put('logs',{ts:Date.now(),type,msg:String(msg)}) }catch(e){console.error(e)}
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  INSTALL (PWA)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;          // save the event
});

installBtn.onclick = async () => {
  /* If event exists â†’ real install flow, else fallback help */
  if (deferredPrompt) {
    try{
      deferredPrompt.prompt();
      const res = await deferredPrompt.userChoice;
      if(res.outcome!=='accepted')
        alert('App install was dismissed â€“ you can install later from your browser menu.');
      deferredPrompt = null;
    }catch(err){ logError('install',err); }
  } else {
    alert('Use your browserâ€™s â€œAdd to Home Screen / Install Appâ€ option.');
  }
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DATA UPLOAD / BACKUP  (GitHub)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const GH_REPO   = 'suhedges/VentX';
const GH_BRANCH = 'main';

/* Get / cache a PAT â€“ clears if 401 later */
async function getToken(){
  if(HARD_TOKEN?.trim()) return HARD_TOKEN.trim();

  let token = localStorage.getItem('gh_token');
  if(token) return token.trim();

  token = prompt('GitHub Personal Access Token (classic) with â€œrepoâ€ scope.\nIt is stored only in this browser.');
  if(token){ localStorage.setItem('gh_token', token.trim()); return token.trim(); }
  return null;
}

/* Generic helper â€“ clears bad tokens automatically */
async function ghRequest(path, opts={}){
  const token = await getToken();
  if(!token) throw new Error('GitHub token required.');
  const res = await fetch(`https://api.github.com${path}`,{
    headers:{
      Authorization:`token ${token}`,
      Accept:'application/vnd.github+json'
    }, ...opts
  });
  if(res.status===401){                 // bad creds â†’ purge and re-prompt next time
    localStorage.removeItem('gh_token');
    throw new Error('GitHub token unauthorized (401). Token has been cleared â€“ try again with a valid one.');
  }
  if(res.ok) return res.json();
  if(res.status===404) return null;
  throw new Error(`GitHub ${res.status}: ${await res.text()}`);
}

/* ---------- RESTORE (single user) ---------- */
async function restoreUserFromGitHub(name){
  try{
    const path  = `backups/${name}.json`;
    const file  = await ghRequest(`/repos/${GH_REPO}/contents/${path}?ref=${GH_BRANCH}`);
    if(!file) return false;                          // nothing there â†’ not existing

    const json  = JSON.parse(decodeURIComponent(escape(atob(file.content))));
    if(!json.data) throw new Error('Invalid backup format');

    /* Ensure unique user */
    if(!(await db.get('users',name))) await db.put('users',{name});

    const tx   = db.transaction(['warehouses','items'],'readwrite');
    const wSto = tx.objectStore('warehouses');
    const iSto = tx.objectStore('items');

    /* wipe any local data for that user first */
    for(const w of await wSto.getAll()) if(w.user===name) await wSto.delete(w.id);
    for(const it of await iSto.getAll()) if(it.whId && it.user===name) await iSto.delete(it.key);

    /* restore */
    for(const bw of json.data){
      await wSto.put({...bw,user:name});
      for(const it of bw.items) await iSto.put(it);
    }
    await tx.done;
    return true;
  }catch(err){ logError('restore',err); alert(err.message); return false; }
}

/* ---------- UPLOAD ---------- */
async function uploadBackup(){
  try{
    const warehouses = (await db.getAll('warehouses')).filter(w=>w.user===user);
    const items      = await db.getAll('items');
    const payload = {
      appVersion : APP_VERSION,
      timestamp  : Date.now(),
      user,
      data : warehouses.map(w=>({...w, items: items.filter(i=>i.whId===w.id)}))
    };
    const content   = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const path      = `backups/${user}.json`;
    const f = await ghRequest(`/repos/${GH_REPO}/contents/${path}?ref=${GH_BRANCH}`);
    const sha = f?.sha || null;
    await ghRequest(`/repos/${GH_REPO}/contents/${path}`,{
      method:'PUT',
      body:JSON.stringify({
        message:`VentX backup for ${user} @ ${new Date().toISOString()}`,
        content, branch:GH_BRANCH, ...(sha && {sha})
      })
    });
    alert('Backup uploaded to GitHub successfully.');
  }catch(err){ logError('uploadBackup',err); alert('Upload failed â†’ '+err.message); }
}
uploadBtn.onclick = uploadBackup;
uploadBtnWH.onclick = uploadBackup;

/* ---------- DOWNLOAD (overwrite current user) ---------- */
async function downloadBackup(){
  if(!confirm('This will OVERWRITE your current data with the GitHub backup. Continue?')) return;
  const ok = await restoreUserFromGitHub(user);
  if(ok){ alert('Backup restored. Reloadingâ€¦'); location.reload(); }
}
downloadBtn.onclick = downloadBackup;

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  LOGIN  (username only)   â€“ now autoâ€‘restore
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
loginForm.onsubmit = async e=>{
  e.preventDefault();
  const name = l_user.value.trim();
  if(!name){ alert('Username required'); return; }

  try{
    let rec = await db.get('users', name);
    if(!rec){
      /* try GitHub */
      const restored = await restoreUserFromGitHub(name);
      if(restored) rec = {name};
    }

    if(rec){
      user = name;
      await loadWarehouses();
      show('wh');
    }else{
      if(confirm('User not found on device or GitHub. Create new user?')){
        await db.put('users',{name});
        user = name;
        await loadWarehouses();
        show('wh');
      }else{
        alert('Invalid user');
      }
    }
  }catch(err){ logError('login',err) }
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  USER MANAGEMENT (keep names uppercase)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
addUserBtn.onclick = async ()=>{
  const uname = prompt('Enter new username:')?.trim().toUpperCase();
  if(!uname) return;
  if(await db.get('users',uname)){ alert('User already exists'); return; }
  await db.put('users',{name:uname});
  alert('User added.');
};
delUserBtn.onclick = async ()=>{
  const uname = prompt('Enter username to delete:')?.trim().toUpperCase();
  if(!uname) return;
  if(!(await db.get('users',uname))){ alert('User does not exist'); return; }
  if(!confirm(`Delete user "${uname}" and all associated data? This cannot be undone.`)) return;
  /* â€¦ unchanged */
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  WAREHOUSES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadWarehouses(){
  const all=await db.getAll('warehouses');
  const mine=all.filter(w=>w.user===user);
  whList.innerHTML = mine.length
    ? mine.map(w=>`
        <li data-wh="${w.id}">
          <span>${w.name}</span>
          <div class="actions">
            <button class="sec" onclick="delWh(${w.id})" title="Delete"><img src="trash-solid.svg" alt=""></button>
          </div>
        </li>`).join('')
    : '<li style="justify-content:center;color:#666">No warehouses yet</li>';
}
window.openWh=(id,name)=>{whId=id;whName=name;render();show('main');};

addWh.onclick=async()=>{
  const n=prompt('Warehouse name?'); if(!n) return;
  const id=await db.add('warehouses',{name:n,user,version:0,created:Date.now()});
  openWh(id,n);
};

window.delWh = async id=>{
  if(!confirm('Delete this warehouse and ALL its items?')) return;
  const tx = db.transaction(['warehouses','items'],'readwrite');
  await tx.objectStore('warehouses').delete(id);
  const idx=tx.objectStore('items');
  for(const it of await idx.getAll()) if(it.whId===id) await idx.delete(it.key);
  await tx.done;
  if(id===whId) show('wh');
  await loadWarehouses();
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ITEM HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const key       = partId => `${whId}|${partId}`;
const getAll    = () => db.getAll('items').then(a=>a.filter(i=>i.whId===whId));
const saveItem  = async o =>{
  o.key=key(o.internal);
  o.whId=whId;
  o.modified=Date.now();
  await db.put('items',o);
  const w=await db.get('warehouses',whId);
  if(w){w.version=(w.version||0)+1;w.modified=Date.now();await db.put('warehouses',w);}  
};
const delItem   = async partId=>{
  await db.delete('items',key(partId));
  const w=await db.get('warehouses',whId);
  if(w){w.version=(w.version||0)+1;w.modified=Date.now();await db.put('warehouses',w);}
};
const byUPC     = u => db.getAll('items').then(a=>a.find(i=>i.whId===whId && i.upc===u));

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  RENDER LIST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function cmp(a,b,field){
  const numFields=['min','max','qty'];
  const av=a[field] ?? '', bv=b[field] ?? '';
  return numFields.includes(field) ? (av-bv) :
    String(av).localeCompare(String(bv),undefined,{numeric:true});
}
async function render (){
  let list = await getAll();

  /* search term */
  const term = searchInput.value.trim().toLowerCase();
  if (term) {
    list = list.filter(i =>
      i.internal.toLowerCase().includes(term) ||
      i.custom?.toLowerCase().includes(term)  ||
      i.bin?.toLowerCase().includes(term)
    );
  }

  /* belowâ€‘min filter */
  if(belowToggle.checked) list = list.filter(i => (i.qty??0) <= (i.min??0));

  list.sort((a,b)=> cmp(a,b,sortField) * (sortDir==='asc'?1:-1));
  itemsBody.innerHTML = list.map(i => `
    <tr data-part="${i.internal.replace(/"/g,'&quot;')}">
      <td class="chk"><input type="checkbox" class="selRow"></td>
      <td data-key="internal">${i.internal}</td>
      <td data-key="custom">${i.custom||''}</td>
      <td data-key="upc">${i.upc||''}</td>
      <td data-key="min">${i.min}</td>
      <td data-key="max">${i.max}</td>
      <td class="qty" data-key="qty">${i.qty}</td>
      <td data-key="bin">${i.bin||''}</td>
      <td class="chk"><img src="trash-solid.svg" class="row-del" title="Delete"></td>
    </tr>`).join('');
  count.textContent = `${whName} \u00B7 ${list.length} items`;
  for(const tr of itemsBody.querySelectorAll('tr')){
    const part=tr.dataset.part;
    tr.querySelector('.selRow').checked=selectedParts.has(part);
  }
  updateBulkUI();
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SELECTION / BULK DELETE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function updateBulkUI(){
  delSel.style.display = selectedParts.size ? '' : 'none';
  selectAll.checked = !!selectedParts.size &&
                      selectedParts.size === itemsBody.querySelectorAll('.selRow').length;
}
itemsBody.addEventListener('change', e=>{
  const cb=e.target.closest('.selRow'); if(!cb) return;
  const part=cb.closest('tr').dataset.part;
  cb.checked ? selectedParts.add(part) : selectedParts.delete(part);
  updateBulkUI();
});
selectAll.addEventListener('change', ()=>{
  const all=itemsBody.querySelectorAll('.selRow');
  selectedParts.clear();
  all.forEach(cb=>{
    cb.checked=selectAll.checked;
    if(cb.checked) selectedParts.add(cb.closest('tr').dataset.part);
  });
  updateBulkUI();
});
delSel.onclick = async ()=>{
  if(!confirm(`Delete ${selectedParts.size} selected items?`)) return;
  for(const part of selectedParts) await delItem(part);
  selectedParts.clear();
  render();
};

/* row trash icon */
itemsBody.addEventListener('click', async e=>{
  const del = e.target.closest('.row-del');
  if(del){
    const tr=del.closest('tr'); const part=tr.dataset.part;
    if(confirm(`Delete ${part}?`)){ await delItem(part); render(); }
    return;
  }
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TABLE CELL INTERACTIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function startQtyEdit(td){
  if(td.isContentEditable) return;
  td.contentEditable='true';
  td.focus();
  document.execCommand?.('selectAll',false,null);
  td.dataset.orig=td.textContent.trim();
}

itemsBody.addEventListener('click', e=>{
  const td=e.target.closest('td'); if(!td) return;
  const field=td.dataset.key;
  const partId=td.parentElement.dataset.part;
  if(field==='qty'){ startQtyEdit(td); }
  else if(!e.target.closest('input') && !e.target.closest('img')) { edit(partId); }
});

/* save qty on blur */
itemsBody.addEventListener('blur', async e=>{
  const td=e.target.closest('td');
  if(!td || td.dataset.key!=='qty') return;
  const val=parseInt(td.textContent.trim(),10);
  const partId=td.parentElement.dataset.part;
  if(!isNaN(val)){
    const it=await db.get('items',key(partId));
    if(it){ it.qty=val; await saveItem(it); }
    td.textContent=val;
  }else td.textContent=td.dataset.orig||0;
  td.removeAttribute('contenteditable');
},true);

/* commit qty on Enter */
itemsBody.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const td=e.target.closest('td');
    if(td && td.dataset.key==='qty'){ e.preventDefault(); td.blur(); }
  }
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SEARCH & TOGGLE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
searchInput.addEventListener('input', render);
belowToggle.addEventListener('change', render);

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  EXPORT  (CSV)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
exportBtn.onclick = ()=>exportDlg.showModal();
expCancel.onclick = ()=>exportDlg.close();

async function exportCSV(onlyLow){
  let items = await getAll();
  if(onlyLow) items = items.filter(i => (i.qty??0) <= (i.min??0));
  const header = ['Internal Part','Custom Part','UPC','Qty','Min','Max','Bin'];
  const csvLines = [header.join(',')];
  const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
  for(const i of items){
    csvLines.push([i.internal,i.custom,i.upc,i.qty,i.min,i.max,i.bin].map(esc).join(','));
  }
  const blob = new Blob([csvLines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = onlyLow ? 'inventory_below_min.csv' : 'inventory_all.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
}

expAll.onclick = ()=>{ exportCSV(false); exportDlg.close(); };
expLow.onclick = ()=>{ exportCSV(true);  exportDlg.close(); };

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  PRODUCT MANAGER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function openManager(it={}){
  current = it;
  hdr.textContent = it.internal || 'Add Item';
  p_internal.value = it.internal||'';  p_custom.value = it.custom||'';  p_upc.value = it.upc||'';
  p_qty.value = it.qty ?? 0; p_min.value = it.min ?? 0; p_max.value = it.max ?? 0; p_bin.value = it.bin||'';
  prodDlg.showModal();
}

window.edit = async partId => {
  const it = await db.get('items', key(partId));
  if (it) openManager(it);
};

prodForm.onsubmit = async e=>{
  e.preventDefault();
  current = {
    internal : p_internal.value.trim(),
    custom   : p_custom.value.trim(),
    upc      : p_upc.value.trim(),
    qty      : +p_qty.value||0,
    min      : +p_min.value||0,
    max      : +p_max.value||0,
    bin      : p_bin.value.trim()
  };
  try{
    await saveItem(current);
    prodDlg.close(); render();
  }catch(err){logError('saveItem',err)}
};
closeProd.onclick = ()=>prodDlg.close();

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  MASS UPC LOGIC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function prepareMassList(){
  let list = await getAll();
  const term = searchInput.value.trim().toLowerCase();
  if (term) {
    list = list.filter(i =>
      i.internal.toLowerCase().includes(term) ||
      i.custom?.toLowerCase().includes(term)  ||
      i.bin?.toLowerCase().includes(term)
    );
  }
  if(belowToggle.checked) list = list.filter(i => (i.qty??0) <= (i.min??0));
  list.sort((a,b)=> cmp(a,b,sortField) * (sortDir==='asc'?1:-1));
  return list.filter(i=>!i.upc);
}
async function startMassUPC(){
  massList = await prepareMassList();
  if(!massList.length){ alert('All visible items already have UPCs'); return; }
  massMode = true; massIndex = 0; showNextMassItem(); startScan();
}
function showNextMassItem(){
  if(massIndex>=massList.length){ scanInfo.textContent=''; return; }
  const it = massList[massIndex];
  scanInfo.textContent = `${it.internal}  |  BIN: ${it.bin||''}`;
}
massUPCBtn.onclick = startMassUPC;

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BARCODE SCANNER (ZXing)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const ZXING_HINTS = new Map([
  [DecodeHintType.POSSIBLE_FORMATS, [
    BarcodeFormat.UPC_A,  BarcodeFormat.UPC_E,
    BarcodeFormat.EAN_13, BarcodeFormat.EAN_8,
    BarcodeFormat.CODE_128, BarcodeFormat.CODE_39
  ]],
  [DecodeHintType.TRY_HARDER,   true],   // spend extra effort per frame
  [DecodeHintType.ALSO_INVERTED,true],   // pick up whiteâ€‘onâ€‘black
  [DecodeHintType.ASSUME_GS1,  true]     // common retail prefixes
]);

/* Ask for the highest profile the device can give us.  
   Browsers will silently fall back if itâ€™s not available. */
const SCAN_CONSTRAINTS = {
  video:{
    facingMode:{ideal:'environment'},
    width     :{ideal:2560},   /* â‰ˆ 2.5â€¯MP â†’ crisp codes */
    height    :{ideal:1440},
    frameRate :{ideal:30, max:60}
  }
};

/* debounce / validation state */
let lastCode      = '';
let stableCount   = 0;
let lastScanTs    = 0;
let reader, stream, captureInto = null;
let autoFocusInterval = null;
/* UI helpers */
fab.onclick        = () => startScan();
btnUPC.onclick     = () => { captureInto = p_upc; prodDlg.close(); startScan(); };
scanCancel.onclick = () => { massMode = false; stopScan(); };

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BARCODE VALIDATION & DEBOUNCE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function validateBarcode(num){
  const len = num.length;
  if(len===12) return validateUpcA(num);
  if(len===13) return validateEan13(num);
  if(len===8)  return validateEan8(num);
  /* Unknown length â€“ accept but still need 2 stable reads */
  return true;
}
function validateUpcA(s){
  let sum=0;
  for(let i=0;i<11;i++) sum += (i%2?1:3)*+s[i];
  return ((10-(sum%10))%10) === +s[11];
}
function validateEan13(s){
  let sum=0;
  for(let i=0;i<12;i++) sum += (i%2?3:1)*+s[i];
  return ((10-(sum%10))%10) === +s[12];
}
function validateEan8(s){
  let sum=0;
  for(let i=0;i<7;i++) sum += (i%2?3:1)*+s[i];
  return ((10-(sum%10))%10) === +s[7];
}

/* Returns the code once it is (a) valid and (b) identical in â‰¥2
   consecutive frames at least 400â€¯ms apart.  Otherwise returns false. */
function handleRawCode(raw){
  const code = raw.trim();
  const now  = Date.now();

  /* basic sanity filter â€“ only 8â€‘14 digits allowed */
  if(!/^\d{8,14}$/.test(code))      return false;
  if(!validateBarcode(code))        return false;
  if(code===lastCode && (now-lastScanTs)<400) return false;  // too soon

  if(code===lastCode) stableCount++; else{ lastCode=code; stableCount=1; }
  lastScanTs = now;

  return stableCount>=2 ? code : false;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“ main entry â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
async function startScan () {
  /* reset stability filter each time we open the scanner */
  lastCode = ''; stableCount = 0;

  scanDlg.showModal();
  try{
    stream = await navigator.mediaDevices.getUserMedia(SCAN_CONSTRAINTS);
    cam.srcObject = stream;
    await cam.play();

    const track = stream.getVideoTracks()[0];
    await applyAutoFocus(track);      // â˜… see next block
    maybeAddTorch(track);
    enableTapFocus(track);

    if('BarcodeDetector' in window){
      startNativeDetector(track);
    }else{
      startZXingDetector();
    }
  }catch(err){
    alert(err.message||err);
    stopScan();
    logError('scan',err);
  }
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CAMERA QUALITY HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function applyAutoFocus(track){
  const caps = track.getCapabilities?.()||{};
  const modes= caps.focusMode||[];
  try{
    if(modes.includes('continuous'))
      await track.applyConstraints({advanced:[{focusMode:'continuous'}]});
    else if(modes.includes('single-shot'))
      await track.applyConstraints({advanced:[{focusMode:'single-shot'}]});

    /* bias lens toward macro distance if supported */
    if(caps.focusDistance && typeof caps.focusDistance.min==='number'){
      await track.applyConstraints({advanced:[{focusDistance:caps.focusDistance.min}]});
    }
  }catch{/* ignore */ }

  /* Kick â€œsingleâ€‘shotâ€ every 1.5â€¯s â€“ many Android cameras need the nudge */
  if(modes.includes('single-shot')){
    autoFocusInterval = setInterval(async()=>{
      try{ await track.applyConstraints({advanced:[{focusMode:'single-shot'}]}); }catch{}
    },1500);
  }
}

function enableTapFocus(track){
  const caps=track.getCapabilities?.()||{};
  if(!caps.pointsOfInterest) return;
  cam.onclick = async e=>{
    const r=cam.getBoundingClientRect();
    const pt={x:(e.clientX-r.left)/r.width, y:(e.clientY-r.top)/r.height};
    try{
      await track.applyConstraints({advanced:[
        {pointsOfInterest:[pt]},
        {focusMode:caps.focusMode?.includes('single-shot')?'single-shot':'continuous'}
      ]});
    }catch{}
  };
}

function maybeAddTorch(track){
  const caps=track.getCapabilities?.()||{};
  if(!caps.torch) return;
  const btn=document.createElement('button');
  btn.id='torchBtn'; btn.textContent='ðŸ’¡'; btn.className='sec';
  btn.style.cssText='position:absolute;top:1rem;right:1rem';
  scanDlg.appendChild(btn);
  btn.onclick = async()=>{
    const on = !(btn.dataset.on==='1');
    await track.applyConstraints({advanced:[{torch:on}]});
    btn.dataset.on = on?'1':'0';
  };
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“ native detector â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
function startNativeDetector(track){
  const detector = new BarcodeDetector({
    formats:['upc_a','upc_e','ean_13','ean_8','code_128','code_39']
  });
  const capture = new ImageCapture(track);

  const loop = async ()=>{
    if(!scanDlg.open) return;
    try{
      const bmp   = await capture.grabFrame();
      const codes = await detector.detect(bmp);
      if(codes.length){
        const ok = handleRawCode(codes[0].rawValue);
        if(ok) return onCode(ok);
      }
    }catch{/* keep looping */}
    requestAnimationFrame(loop);
  };
  loop();
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“ ZXing fallback â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
function startZXingDetector(){
  reader = new BrowserMultiFormatReader(ZXING_HINTS,200);
  reader.decodeFromConstraints(SCAN_CONSTRAINTS,cam,(result,err)=>{
    if(result){
      const ok = handleRawCode(result.getText());
      if(ok) onCode(ok);
    }
  });
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“ common helpers â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
function stopScan(){
  reader?.reset?.();
  stream?.getTracks().forEach(t=>t.stop());
  clearInterval(autoFocusInterval); autoFocusInterval=null;
  lastCode=''; stableCount=0;
  scanDlg.close();
  document.getElementById('torchBtn')?.remove();
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  HANDLING SCAN RESULT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function onCode (code) {
  // Existing logic unchangedâ€¦
  if (captureInto) {
    captureInto.value = code;
    captureInto = null;
    stopScan();
    prodDlg.showModal();
    return;
  }

  if (massMode) {
    const it = massList[massIndex];
    it.upc = code;
    await saveItem(it);
    massIndex++;
    if (massIndex < massList.length) {
      showNextMassItem();
    } else {
      massMode = false;
      alert('Mass UPC complete!');
      stopScan();
      render();
    }
    return;
  }

  const existing = await byUPC(code);
  if (existing) {
    alert(`UPC already exists on ${existing.internal}`);
    stopScan();
    return;
  }

  p_upc.value = code;
  stopScan();
  prodDlg.showModal();
}
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  IMPORT CSV / XLSX
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
impBtn.onclick = ()=>importFile.click();
importFile.onchange = async e=>{
  const file=e.target.files[0]; if(!file) return;
  const ext=file.name.split('.').pop().toLowerCase(); let rows=[];
  try{
    if(ext==='csv'){
      const txt=await file.text();
      const Papa=(await import('https://cdn.jsdelivr.net/npm/papaparse@5/+esm')).default;
      rows=Papa.parse(txt,{header:true}).data;
    }else{
      const buf=await file.arrayBuffer();
      const XLSX=(await import('https://cdn.jsdelivr.net/npm/xlsx@0.20.3/+esm')).default;
      const wb=XLSX.read(buf,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      rows=XLSX.utils.sheet_to_json(ws);
    }
    for(const r of rows){
      const internal=String(r['Internal Part']||r.internal||r.Internal||'').trim();
      if(!internal) continue;
      const exists=await db.get('items',key(internal));
      if(exists && !confirm(`${internal} exists. Overwrite?`)) continue;
      await saveItem({
        internal, custom:String(r['Custom Part']||r.custom||r.Custom||'').trim(),
        upc:String(r.UPC||r.upc||'').trim(), qty:exists?exists.qty:0,
        min:+(r.Min||r.min||0), max:+(r.Max||r.max||0), bin:String(r.Bin||r.bin||'').trim()
      });
    }
    render(); importFile.value='';
  }catch(err){logError('import',err)}
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CSV TEMPLATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
tmplBtn.onclick = ()=>{
  const csv=['Internal Part','Custom Part','UPC','Min','Max','Bin'].join(',')+'\n';
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='import_template.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  NAVIGATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
backWh.onclick=()=>{ show('wh'); loadWarehouses(); };

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SERVICE-WORKER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

</script>
</body>
</html>
