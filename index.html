<!--  index.html  â€“  replace the old file completely  -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VentX â€“ Phone Stock Manager</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico">

<style>
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  THEME  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root{
    --blue:#2563eb;
    --gray:#1f2937;
    --radius:8px;
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%}
  body{display:flex;flex-direction:column;background:#f8fafc;color:#111}

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SHARED  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  button{
    border:none;border-radius:6px;padding:.5rem 1rem;
    font-size:1rem;cursor:pointer;line-height:1.2
  }
  .sec{background:#e5e7eb}
  .pri{background:var(--blue);color:#fff}
  input,select{
    width:100%;padding:.45rem;border:1px solid #cbd5e1;border-radius:4px;font-size:1rem
  }
  label{display:flex;flex-direction:column;gap:.25rem;font-weight:600}

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  DIALOGS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  dialog{
    border:none;border-radius:var(--radius);padding:1rem;width:92%;max-width:480px;
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#fff
  }
  dialog::backdrop{background:#0007}

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SCREENS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .screen{flex:1;display:none;flex-direction:column}
  .show{display:flex}

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  LOGIN  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #login form{
    margin:auto;width:90%;max-width:380px;border:1px solid #d1d5db;
    padding:2rem;border-radius:var(--radius);background:#fff
  }
  #login h2{margin-bottom:1rem;text-align:center}
  #installBtn{margin-top:.6rem;width:100%;display:none}

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  WAREHOUSES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #wh header{background:var(--gray);color:#fff;padding:.8rem 1rem;font-size:1.25rem}
  #wh ul{list-style:none;padding:1rem;gap:.6rem;display:flex;flex-direction:column}
  #wh li{
    padding:.7rem .9rem;border:1px solid #d1d5db;border-radius:6px;
    display:flex;justify-content:space-between;align-items:center;background:#fff
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  MAIN  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main header{
    display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;
    background:var(--gray);color:#fff;padding:.7rem .9rem
  }
  #main header input{max-width:220px}
  #main header select{width:auto}
  #main header span{margin-left:auto}
  #items{flex:1;overflow:auto;padding:1rem;list-style:none}
  #items li{
    margin:.25rem 0;padding:.4rem .6rem;border:1px solid #d1d5db;
    border-radius:6px;display:flex;justify-content:space-between;align-items:flex-start;
    background:#fff;gap:.75rem
  }
  #items li:hover{cursor:pointer;background:#eceded}
  #items .meta{font-size:.8rem;color:#555;margin-top:.15rem}
  #fab{
    position:fixed;right:1rem;bottom:1rem;width:56px;height:56px;
    background:var(--blue);color:#fff;border:none;border-radius:50%;
    font-size:28px;box-shadow:0 4px 12px #0004
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  PROD-DIALOG GRID  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #prodDlg form{
    display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(140px,1fr))
  }
  #prodDlg h3{grid-column:1/-1;margin-bottom:.25rem;text-align:center}
  #prodDlg .full{grid-column:1/-1}
  #prodDlg .row{display:flex;gap:.5rem}
  #prodDlg .actions{grid-column:1/-1;display:flex;gap:.6rem;justify-content:flex-end;margin-top:.25rem}

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SCAN-DIALOG  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #scanDlg video{width:100%;border-radius:var(--radius)}
</style>
</head>
<body>

<!----- LOGIN ----->
<section id="login" class="screen show">
  <form id="loginForm">
    <h2>Login</h2>
    <label>Username <input id="l_user" required></label>
    <label>Password <input id="l_pass" type="password" required></label>
    <button class="pri" style="margin-top:1.5rem;width:100%">Sign in</button>
    <button id="installBtn" class="sec">Install App</button>
  </form>
</section>

<!----- WAREHOUSES ----->
<section id="wh" class="screen">
  <header>Warehouses</header>
  <ul id="whList"></ul>
  <button id="addWh" class="pri" style="margin:1rem">ï¼‹ Add Warehouse</button>
</section>

<!----- MAIN ----->
<section id="main" class="screen">
  <header>
    <button id="backWh" class="sec">Warehouses</button>
    <button id="impBtn"  class="sec">Import</button>
    <button id="tmplBtn" class="sec">Download&nbsp;Template</button>
    <button id="uploadBtn" class="sec">Upload</button>
    <button id="downloadBtn" class="sec">Download&nbsp;Backup</button>

    <input id="searchInput" placeholder="Searchâ€¦">
    <select id="sortSelect" class="sec" title="Sort" placeholder:"Sort">
      <option value="internal">Part # â†‘</option>
      <option value="internal-desc">Part # â†“</option>
      <option value="bin">Bin â†‘</option>
      <option value="bin-desc">Bin â†“</option>
    </select>
    <span id="count"></span>
  </header>

  <ul id="items"></ul>
  <button id="fab" title="Scan product">ðŸ“·</button>
</section>

<!----- SCAN DIALOG ----->
<dialog id="scanDlg">
  <video id="cam" playsinline></video>
  <p align="center">Point camera at barcodeâ€¦</p>
  <button class="sec" id="scanCancel" style="width:100%">Cancel</button>
</dialog>

<!----- PRODUCT MANAGER ----->
<dialog id="prodDlg">
  <form id="prodForm" novalidate>
    <h3 id="hdr">Add / Edit Item</h3>

    <label class="full">Internal&nbsp;Part <input id="p_internal" required></label>
    <label class="full">Custom&nbsp;Part <input id="p_custom"></label>

    <label class="full">UPC
      <div class="row">
        <input id="p_upc">
        <button type="button" class="sec" id="btnUPC">Scan UPC</button>
      </div>
    </label>

    <label>Qty <input id="p_qty" type="number" required></label>
    <label>Min <input id="p_min" type="number" required></label>
    <label>Max <input id="p_max" type="number" required></label>
    <label class="full">Bin <input id="p_bin"></label>

    <div class="actions">
      <button type="button" class="sec" id="closeProd">Close</button>
      <button class="pri">Save</button>
    </div>
  </form>
</dialog>

<!----- FILE IMPORT INPUT (hidden) ----->
<input id="importFile" type="file" accept=".csv,.xlsx,.xls" style="display:none">

<script type="module">

const downloadBtn = $('downloadBtn');

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  EXTERNAL LIBS (lazy-loaded where possible)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';
import { BrowserMultiFormatReader } from 'https://cdn.skypack.dev/@zxing/library@0.20.0';

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CONSTANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const APP_VERSION = '2025-07-15';

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DOM REFERENCES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const $ = id => document.getElementById(id);
const scanDlg=$('scanDlg'), scanCancel=$('scanCancel'), cam=$('cam');
const fab=$('fab'), impBtn=$('impBtn'), tmplBtn=$('tmplBtn'), importFile=$('importFile');
const loginForm=$('loginForm'), l_user=$('l_user'), l_pass=$('l_pass'), installBtn=$('installBtn');
const whList=$('whList'), addWh=$('addWh');
const p_internal=$('p_internal'), p_custom=$('p_custom'), p_upc=$('p_upc');
const p_qty=$('p_qty'), p_min=$('p_min'), p_max=$('p_max'), p_bin=$('p_bin');
const hdr=$('hdr'), prodDlg=$('prodDlg'), prodForm=$('prodForm');
const closeProd=$('closeProd'), btnUPC=$('btnUPC');
const backWh=$('backWh'), items=$('items'), count=$('count');
const searchInput=$('searchInput'), sortSelect=$('sortSelect'), uploadBtn=$('uploadBtn');

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  STATE HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let user=null, whId=null, whName=null, current=null, deferredPrompt=null;
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.toggle('show',s.id===id));}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  INDEXED-DB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const db = await openDB('inventory', 4, {
  upgrade(db, oldVersion){
    if(oldVersion<1 && !db.objectStoreNames.contains('users'))
      db.createObjectStore('users',{keyPath:'name'});
    if(oldVersion<2 && !db.objectStoreNames.contains('warehouses'))
      db.createObjectStore('warehouses',{keyPath:'id',autoIncrement:true});
    if(oldVersion<3 && !db.objectStoreNames.contains('items'))
      db.createObjectStore('items',{keyPath:'key'});
    if(oldVersion<4 && !db.objectStoreNames.contains('logs'))
      db.createObjectStore('logs',{keyPath:'ts'});
  }
});
await navigator.storage?.persist?.();          // ask for persistent quota

/* seed demo users */
for(const u of ['US1','US2'])
  if(!(await db.get('users',u))) db.put('users',{name:u,pass:u});

/* simple logger */
async function logError(type,msg){
  try{ await db.put('logs',{ts:Date.now(),type,msg:String(msg)}) }catch(e){console.error(e)}
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  INSTALL (PWA)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display='block';
});
installBtn.onclick = async()=>{
  try{
    if(window.matchMedia('(display-mode: standalone)').matches){
      const overwrite = confirm('VentX is already installed. Overwrite installation?');
      if(!overwrite) return;
      // clear existing caches so the new build installs fresh
      const keys = await caches.keys();
      await Promise.all(keys.map(k=>caches.delete(k)));
    }
    if(deferredPrompt){
      deferredPrompt.prompt();
      const res = await deferredPrompt.userChoice;
      if(res.outcome==='accepted') installBtn.style.display='none';
      deferredPrompt=null;
    }
  }catch(err){logError('install',err)}
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  LOGIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
loginForm.onsubmit=async e=>{
  e.preventDefault();
  try{
    const rec=await db.get('users',l_user.value.trim());
    if(rec?.pass===l_pass.value.trim()){
      user=rec.name; await loadWarehouses(); show('wh');
    }else alert('Invalid credentials');
  }catch(err){logError('login',err)}
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  WAREHOUSES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadWarehouses(){
  const all=await db.getAll('warehouses');
  const mine=all.filter(w=>w.user===user);
  whList.innerHTML = mine.length
    ? mine.map(w=>`
        <li>
          <span>${w.name}</span>
          <button class="pri" onclick="openWh(${w.id},'${w.name.replace(/'/g,'&#39;')}')">Open</button>
        </li>`).join('')
    : '<li style="justify-content:center;color:#666">No warehouses yet</li>';
}
window.openWh=(id,name)=>{whId=id;whName=name;render();show('main');};

addWh.onclick=async()=>{
  const n=prompt('Warehouse name?'); if(!n) return;
  const id=await db.add('warehouses',{name:n,user,version:0,created:Date.now()});
  openWh(id,n);
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ITEM HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const key       = partId => `${whId}|${partId}`;
const getAll    = () => db.getAll('items').then(a=>a.filter(i=>i.whId===whId));
const saveItem  = async o =>{
  o.key=key(o.internal);
  o.whId=whId;
  o.modified=Date.now();
  await db.put('items',o);
  const w=await db.get('warehouses',whId);
  if(w){w.version=(w.version||0)+1;w.modified=Date.now();await db.put('warehouses',w);}
};
const byUPC     = u => db.getAll('items').then(a=>a.find(i=>i.whId===whId && i.upc===u));

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  RENDER LIST  (filter + sort)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function render(){
  let list = await getAll();

  /* Filter */
  const term = searchInput.value.trim().toLowerCase();
  if(term){
    list = list.filter(i =>
      i.internal.toLowerCase().includes(term) ||
      i.custom?.toLowerCase().includes(term)  ||
      i.bin?.toLowerCase().includes(term));
  }

  /* Sort */
  const [field,dir] = sortSelect.value.split('-');
  list.sort((a,b)=> (a[field]||'').localeCompare(b[field]||'',undefined,{numeric:true}));
  if(dir==='desc') list.reverse();

  /* Paint */
  items.innerHTML = list.map(i=>`
    <li onclick="edit('${i.internal.replace(/'/g,'&#39;')}')">
      <div style="flex:1">
        <span>${i.internal}${i.custom?` / ${i.custom}`:''}</span>
        <span class="meta">
          Min&nbsp;${i.min}&nbsp;Â·&nbsp;Max&nbsp;${i.max}&nbsp;Â·&nbsp;Bin&nbsp;${i.bin||'â€”'}
        </span>
      </div>
      <strong>${i.qty}</strong>
    </li>`).join('');
  count.textContent = `${whName} Â· ${list.length} items`;
}
window.edit = async internal => { const it=await db.get('items',key(internal)); it&&openManager(it); };

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SEARCH / SORT CONTROLS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
['input','change'].forEach(ev=>{
  searchInput.addEventListener(ev,render);
  sortSelect .addEventListener(ev,render);
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  PRODUCT MANAGER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function openManager(it={}){
  current = it;
  hdr.textContent = it.internal || 'Add Item';
  p_internal.value = it.internal||'';  p_custom.value = it.custom||'';
  p_upc.value      = it.upc||'';       p_qty.value   = it.qty ?? 0;
  p_min.value      = it.min ?? 0;      p_max.value   = it.max ?? 0;
  p_bin.value      = it.bin||'';
  prodDlg.showModal();
}

prodForm.onsubmit = async e=>{
  e.preventDefault();
  current = {
    internal : p_internal.value.trim(),
    custom   : p_custom.value.trim(),
    upc      : p_upc.value.trim(),
    qty      : +p_qty.value||0,
    min      : +p_min.value||0,
    max      : +p_max.value||0,
    bin      : p_bin.value.trim()
  };
  try{
    await saveItem(current);
    prodDlg.close();
    render();
  }catch(err){logError('saveItem',err)}
};
closeProd.onclick = ()=>prodDlg.close();

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BARCODE SCANNER (ZXing)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let reader, stream, captureInto=null;   // captureInto = input element to receive code

fab.onclick     = ()=>startScan(null);   // lookup mode
btnUPC.onclick  = ()=>{
  captureInto = p_upc;
  prodDlg.close();
  startScan(p_upc);
};
scanCancel.onclick = stopScan;

async function startScan(){
  scanDlg.showModal();
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    cam.srcObject = stream; await cam.play();

    reader = new BrowserMultiFormatReader(undefined,45);   // 45 fps cap
    reader.decodeFromVideoElement(cam,(res)=>{
      if(res){ onCode(res.getText()); }
    });
  }catch(err){
    alert(err.message||err); stopScan(); logError('scan',err);
  }
}

function stopScan(){
  reader?.reset?.();
  stream?.getTracks().forEach(t=>t.stop());
  scanDlg.close();
}

async function onCode(code){
  stopScan();
  /* Destination depends on mode */
  if(captureInto){
    captureInto.value = code;
    captureInto = null;
    prodDlg.showModal();
    return;
  }
  /* lookup mode */
  const it = await byUPC(code) || await db.get('items',key(code));
  if(it){ openManager(it); }
  else   alert(`${code} not found`);
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  IMPORT CSV / XLSX
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
impBtn.onclick = ()=>importFile.click();
importFile.onchange = async e=>{
  const file=e.target.files[0]; if(!file) return;
  const ext=file.name.split('.').pop().toLowerCase();
  let rows=[];
  try{
    if(ext==='csv'){
      const txt=await file.text();
      const Papa = (await import('https://cdn.jsdelivr.net/npm/papaparse@5/+esm')).default;
      rows = Papa.parse(txt,{header:true}).data;
    }else{
      const buf=await file.arrayBuffer();
      const XLSX=(await import('https://cdn.jsdelivr.net/npm/xlsx@0.20.3/+esm')).default;
      const wb=XLSX.read(buf,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      rows=XLSX.utils.sheet_to_json(ws);
    }

    for(const r of rows){
      const internal=String(r['Internal Part']||r.internal||r.Internal||'').trim();
      if(!internal) continue;
      const exists = await db.get('items',key(internal));
      if(exists && !confirm(`${internal} exists. Overwrite?`)) continue;
      await saveItem({
        internal,
        custom:String(r['Custom Part']||r.custom||r.Custom||'').trim(),
        upc:String(r.UPC||r.upc||'').trim(),
        qty:exists?exists.qty:0,
        min:+(r.Min||r.min||0),
        max:+(r.Max||r.max||0),
        bin:String(r.Bin||r.bin||'').trim()
      });
    }
    render(); importFile.value='';
  }catch(err){logError('import',err)}
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CSV TEMPLATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
tmplBtn.onclick = ()=>{
  const csv=['Internal Part','Custom Part','UPC','Min','Max','Bin'].join(',')+'\n';
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='import_template.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DATA UPLOAD / BACKUP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
uploadBtn.onclick = async()=>{
  if(!navigator.onLine){alert('You appear to be offline. Connect to the internet and try again.');return;}
  try{
    const warehouses = (await db.getAll('warehouses')).filter(w=>w.user===user);
    const items      = await db.getAll('items');
    const payload    = {appVersion:APP_VERSION,user,warehouses,items,timestamp:Date.now()};

    const res = await fetch('https://suhedges.github.io/VentX/api/upload',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(`Server responded ${res.status}`);
    const reply = await res.json(); // expected: {latestVersions:{[id]:num}}
    const conflict = warehouses.some(w => reply.latestVersions?.[w.id] > w.version);
    if(conflict && !confirm('Remote data is newer than your local copy. Overwrite remote data?')) return;
    alert('Backup complete âœ”');
  }catch(err){
    alert('Backup failed. See console for details.');
    logError('upload',err);
    console.error(err);
  }
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  NEW: BACKUP DOWNLOAD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
downloadBtn.onclick = async () => {
  if (!navigator.onLine) {
    alert('You are offline â€“ cannot fetch backups.');
    return;
  }
  try {
    const url =
      `https://suhedges.github.io/VentX/backups/${user}/latest.json?` +
      Date.now(); // bust cache
    const res = await fetch(url);
    if (!res.ok) throw new Error('No backup found for this user.');
    const blob = await res.blob();

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download =
      `VentX-backup-${user}-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  } catch (err) {
    alert(`Download failed: ${err.message}`);
    logError('download', err);
  }
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  NAVIGATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
backWh.onclick = ()=>{ show('wh'); loadWarehouses(); };

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SERVICE-WORKER  (register after all listeners)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
if('serviceWorker' in navigator)
  navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
