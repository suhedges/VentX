<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VentX – Phone Stock Manager</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico">

<style>
/* ───────────  THEME  ─────────── */
:root{
  --blue:#2563eb;
  --blue-hover:#1e4fc0;
  --gray:#1f2937;
  --light:#f8fafc;
  --radius:8px;
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif
}
*{box-sizing:border-box;margin:0;padding:0}
body,html{height:100%}
body{display:flex;flex-direction:column;background:var(--light);color:#111}

/* ───────────  SHARED  ─────────── */
button{
  --bg:#e5e7eb;--fg:#111;
  border:none;border-radius:6px;padding:.55rem 1.05rem;
  font-size:1rem;cursor:pointer;line-height:1.2;
  display:inline-flex;align-items:center;gap:.45rem;
  background:var(--bg);color:var(--fg);
  transition:background .15s,box-shadow .15s,transform .15s;
}
button img{width:18px;height:18px}
button:active{transform:translateY(1px)}
button:hover{box-shadow:0 2px 6px #0002}
.pri{--bg:var(--blue);--fg:#fff}
.pri:hover{background:var(--blue-hover)}
.sec:hover{background:#d1d5db}

/* modernize inputs & selects */
input,select{
  width:100%;padding:.5rem .75rem;
  border:1px solid #cbd5e1;border-radius:6px;font-size:1rem;background:#fff;
}
label{display:flex;flex-direction:column;gap:.25rem;font-weight:600}

/* ───────────  TOGGLE  ─────────── */
.toggle{display:inline-flex;align-items:center;gap:.4rem;font-size:.95rem;font-weight:500;cursor:pointer}
.toggle input{
  appearance:none;width:42px;height:24px;border-radius:12px;background:#cbd5e1;outline:none;position:relative;transition:background .2s
}
.toggle input::before{
  content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform .2s
}
.toggle input:checked{background:var(--blue)}
.toggle input:checked::before{transform:translateX(18px)}

/* ───────────  DIALOGS  ─────────── */
dialog{
  border:none;border-radius:var(--radius);padding:1rem;width:92%;max-width:480px;
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:#fff;box-shadow:0 6px 24px #0003
}
dialog::backdrop{background:#0006}

/* ───────────  SCREENS  ─────────── */
.screen{flex:1;display:none;flex-direction:column}
.show{display:flex}

/* ───────────  LOGIN  ─────────── */
#login form{
  margin:auto;width:90%;max-width:380px;border:1px solid #d1d5db;
  padding:2rem;border-radius:var(--radius);background:#fff;box-shadow:0 4px 18px #0001
}
#login h2{margin-bottom:1rem;text-align:center}
#installBtn{margin-top:.6rem;width:100%}

/* ───────────  WAREHOUSES  ─────────── */
#wh header{background:var(--gray);color:#fff;padding:.9rem 1.2rem;font-size:1.3rem}
#wh ul{list-style:none;padding:1rem;gap:.7rem;display:flex;flex-direction:column}
#wh li{
  padding:.8rem 1rem;border:1px solid #d1d5db;border-radius:8px;
  display:flex;justify-content:space-between;align-items:center;background:#fff;
  box-shadow:0 2px 4px #0001
}
#wh li .actions{display:flex;gap:.4rem}

/* ───────────  MAIN  ─────────── */
#main header{
  display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;
  background:var(--gray);color:#fff;padding:.8rem 1rem
}
#main header input{max-width:220px}
#main header span{margin-left:auto;font-weight:500}
#delSel{display:none}

/* -- items table wrapper -- */
#itemsWrap{flex:1;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:.55rem .8rem;border-bottom:1px solid #d1d5db;text-align:left;white-space:nowrap}
tbody tr:hover{background:#eef0f2;cursor:pointer}
th{background:#f1f5f9;position:sticky;top:0;z-index:1;cursor:pointer;user-select:none}
th.sort-asc::after{content:" ▲";font-size:.75rem}
th.sort-desc::after{content:" ▼";font-size:.75rem}
td.qty{text-align:right;font-weight:600}
td.qty[contenteditable]:focus{outline:2px solid var(--blue)}
th.chk,td.chk{width:42px;text-align:center}
.row-del{cursor:pointer}

/* ───────────  FAB  ─────────── */
#fab{
  position:fixed;right:1.2rem;bottom:1.2rem;width:60px;height:60px;
  background:#A6CBE2;color:#fff;border:solid black;border-radius:50%;
  display:flex;justify-content:center;align-items:center
}
#fab img{width:28px;height:28px}

/* ───────────  PROD‑DIALOG GRID  ─────────── */
#prodDlg form{display:grid;gap:.9rem;grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
#prodDlg h3{grid-column:1/-1;margin-bottom:.25rem;text-align:center}
#prodDlg .full{grid-column:1/-1}
#prodDlg .row{display:flex;gap:.6rem}
#prodDlg .actions{grid-column:1/-1;display:flex;gap:.7rem;justify-content:flex-end;margin-top:.3rem}

/* ───────────  EXPORT DIALOG  ─────────── */
#exportDlg h4{margin-bottom:.75rem}
#exportDlg button{width:100%}

/* ───────────  SCAN‑DIALOG  ─────────── */
#scanDlg video{width:100%;border-radius:var(--radius)}
#scanInfo{margin-bottom:.4rem;font-size:1rem;font-weight:600}

/* ───────────  MOBILE OVERRIDES  ─────────── */
@media(max-width:640px){
  /* header wraps vertically so nothing forces width */
  #main header{flex-direction:column;align-items:stretch}
  #main header button,#main header input{width:100%;max-width:100%}

  /* responsive table → stacked cards */
  table{min-width:0}
  thead{display:none}
  tbody tr{display:block;border:1px solid #d1d5db;margin:.65rem 0;border-radius:6px}
  tbody td{
    display:flex;justify-content:space-between;align-items:center;
    padding:.65rem .8rem;border:none;white-space:normal
  }
  tbody td::before{
    content:attr(data-key);
    font-weight:600;color:#555;text-transform:capitalize
  }
  td.chk{display:none}
  td.qty{text-align:left}
}
/* end mobile */
</style>
</head>
<body>
<!--‑‑‑‑‑ LOGIN ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑-->
<section id="login" class="screen show">
  <form id="loginForm">
    <h2>Login</h2>
    <label>Username <input id="l_user" required autocomplete="username"></label>

    <button class="pri" style="margin-top:1.6rem;width:100%">Sign in</button>

    <div style="display:flex;gap:.5rem;margin-top:.6rem">
      <button id="addUserBtn" class="sec" style="flex:1">Add&nbsp;User</button>
      <button id="delUserBtn" class="sec" style="flex:1">Remove&nbsp;User</button>
    </div>
    <button id="installBtn" class="sec">Install&nbsp;App</button>
  </form>
</section>

<!--‑‑‑‑‑ WAREHOUSES ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑-->
<section id="wh" class="screen">
  <header>Warehouses</header>
  <ul id="whList"></ul>
  <div style="display:flex;gap:.6rem;margin:1rem">
    <button id="addWh"      class="pri">＋ Add Warehouse</button>
    <button id="uploadBtnWH" class="sec">Upload Backup</button>
  </div>
</section>

<!--‑‑‑‑‑ MAIN ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑-->
<section id="main" class="screen">
  <header>
    <button id="backWh" class="sec">
      <img src="circle-left-regular.svg" alt="" /> Warehouses
    </button>
    <button id="impBtn"  class="sec">
      <img src="download-solid.svg" style="opacity:.7" alt=""> Import
    </button>
    <button id="tmplBtn" class="sec">
      <img src="download-solid.svg" style="opacity:.7" alt=""> Download&nbsp;Template
    </button>
    <button id="uploadBtn" class="sec">
      <img src="cloud-arrow-up-solid.svg" alt=""> Upload
    </button>
    <button id="downloadBtn" class="sec">
      <img src="download-solid.svg" alt=""> Download&nbsp;Backup
    </button>
    <button id="exportBtn" class="sec">
      <img src="file-export-solid.svg" alt=""> Export
    </button>
    <button id="massUPCBtn" class="sec">
      <img src="barcode-solid.svg" alt=""> Mass&nbsp;UPC
    </button>
    <button id="delSel" class="sec">
      <img src="trash-solid.svg" alt=""> Delete&nbsp;Selected
    </button>

    <input id="searchInput" placeholder="Search…">
    <label class="toggle" title="Show only items at/below Min">
      <input type="checkbox" id="belowToggle">
      <span>Below&nbsp;Min</span>
    </label>
    <span id="count"></span>
  </header>

  <div id="itemsWrap">
    <table id="itemsTable">
      <thead>
        <tr>
          <th class="chk"><input type="checkbox" id="selectAll"></th>
          <th data-key="internal">TSB#</th>
          <th data-key="custom">CustPN</th>
          <th data-key="upc">UPC</th>
          <th data-key="min">Min</th>
          <th data-key="max">Max</th>
          <th data-key="qty">Qty</th>
          <th data-key="bin">BIN</th>
          <th class="chk"></th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <button id="fab" title="Scan product">
    <img src="camera-solid.svg" alt="Scan">
  </button>
</section>

<!--‑‑‑‑‑ SCAN DIALOG ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑-->
<dialog id="scanDlg">
  <h4 id="scanInfo" style="text-align:center"></h4>
  <video id="cam" playsinline></video>
  <p align="center">Point camera at barcode…</p>
  <button class="sec" id="scanCancel" style="width:100%">Cancel</button>
</dialog>

<!--‑‑‑‑‑ PRODUCT MANAGER ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑-->
<dialog id="prodDlg">
  <form id="prodForm" novalidate>
    <h3 id="hdr">Add / Edit Item</h3>

    <label class="full">Internal&nbsp;Part <input id="p_internal" required></label>
    <label class="full">Custom&nbsp;Part   <input id="p_custom"></label>

    <label class="full">UPC
      <div class="row">
        <input id="p_upc">
        <button type="button" class="sec" id="btnUPC">
          <img src="camera-solid.svg" alt="" style="opacity:.7"> Scan&nbsp;UPC
        </button>
      </div>
    </label>

    <label>Qty <input id="p_qty" type="number" required></label>
    <label>Min <input id="p_min" type="number" required></label>
    <label>Max <input id="p_max" type="number" required></label>
    <label class="full">Bin <input id="p_bin"></label>

    <div class="actions">
      <button type="button" class="sec" id="closeProd">Close</button>
      <button class="pri">Save</button>
    </div>
  </form>
</dialog>

<!--‑‑‑‑‑ EXPORT DIALOG  ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑-->
<dialog id="exportDlg">
  <h4>Export Inventory</h4>
  <button id="expAll" class="pri">Export ALL Items</button>
  <button id="expLow" class="sec">Export Items Below Min</button>
  <button id="expCancel" class="sec">Cancel</button>
</dialog>

<!--‑‑‑‑‑ FILE IMPORT INPUT (hidden) ‑‑‑‑‑‑‑‑-->
<input id="importFile" type="file" accept=".csv,.xlsx,.xls" hidden>

<script type="module">

/*────────────────────────────────────
  DOM REFERENCES
────────────────────────────────────*/
const $ = id => document.getElementById(id);
const downloadBtn=$('downloadBtn');
const exportBtn=$('exportBtn'), exportDlg=$('exportDlg'), expAll=$('expAll'), expLow=$('expLow'), expCancel=$('expCancel');
const belowToggle=$('belowToggle');
const scanDlg=$('scanDlg'), scanCancel=$('scanCancel'), cam=$('cam');
const fab=$('fab'), impBtn=$('impBtn'), tmplBtn=$('tmplBtn'), importFile=$('importFile');
const loginForm=$('loginForm'), l_user=$('l_user'), installBtn=$('installBtn');
const addUserBtn=$('addUserBtn'), delUserBtn=$('delUserBtn');
const whList=$('whList'), addWh=$('addWh');
const p_internal=$('p_internal'), p_custom=$('p_custom'), p_upc=$('p_upc');
const p_qty=$('p_qty'), p_min=$('p_min'), p_max=$('p_max'), p_bin=$('p_bin');
const hdr=$('hdr'), prodDlg=$('prodDlg'), prodForm=$('prodForm');
const closeProd=$('closeProd'), btnUPC=$('btnUPC');
const backWh=$('backWh'), itemsBody=$('itemsBody'), count=$('count');
const searchInput=$('searchInput'), uploadBtn=$('uploadBtn'), uploadBtnWH=$('uploadBtnWH');
const thead = $('itemsTable').querySelector('thead');
const selectAll=$('selectAll'), delSel=$('delSel');
const massUPCBtn=$('massUPCBtn'), scanInfo=$('scanInfo');

/*────────────────────────────────────
  EXTERNAL LIBS
────────────────────────────────────*/
import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';
import {
  BrowserMultiFormatReader,
  DecodeHintType,
  BarcodeFormat
} from 'https://cdn.skypack.dev/@zxing/library@0.20.0';

/*────────────────────────────────────
  CONSTANTS
────────────────────────────────────*/
const APP_VERSION = '2025-07-15';

/* -------------- PAT HANDLING --------------
   Leave blank; you’ll be prompted once,
   then token is cached in localStorage.
-------------------------------------------*/
const HARD_TOKEN = [
  'gh','p_DI','B459','Q4L8','p9QJ','tlJx','uDHn','8jW9','eb2r','1u4E','mu'
].join('');

let sortField='internal', sortDir='asc';
thead.addEventListener('click', e=>{
  const th=e.target.closest('th[data-key]'); if(!th) return;
  const key=th.dataset.key;
  if(sortField===key){ sortDir=sortDir==='asc'?'desc':'asc'; }
  else{ sortField=key; sortDir='asc'; }
  thead.querySelectorAll('th').forEach(th=>th.classList.remove('sort-asc','sort-desc'));
  th.classList.add(sortDir==='asc'?'sort-asc':'sort-desc');
  render();
});

/*────────────────────────────────────
  STATE HELPERS
────────────────────────────────────*/
let user=null, whId=null, whName=null, current=null, deferredPrompt=null;
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.toggle('show',s.id===id));}

/* MASS UPC STATE */
let massMode=false, massList=[], massIndex=0;

/* SELECTION STATE */
const selectedParts=new Set();

/*────────────────────────────────────
  INDEXED-DB
────────────────────────────────────*/
const db = await openDB('inventory', 4, {
  upgrade(db, oldVersion){
    if(oldVersion<1 && !db.objectStoreNames.contains('users'))
      db.createObjectStore('users',{keyPath:'name'});
    if(oldVersion<2 && !db.objectStoreNames.contains('warehouses'))
      db.createObjectStore('warehouses',{keyPath:'id',autoIncrement:true});
    if(oldVersion<3 && !db.objectStoreNames.contains('items'))
      db.createObjectStore('items',{keyPath:'key'});
    if(oldVersion<4 && !db.objectStoreNames.contains('logs'))
      db.createObjectStore('logs',{keyPath:'ts'});
  }
});
await navigator.storage?.persist?.();

/* seed demo users */
for(const u of ['US1','US2'])
  if(!(await db.get('users',u))) db.put('users',{name:u});

/* simple logger */
async function logError(type,msg){
  try{ await db.put('logs',{ts:Date.now(),type,msg:String(msg)}) }catch(e){console.error(e)}
}

/*────────────────────────────────────
  INSTALL (PWA)
────────────────────────────────────*/
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;          // save the event
});

installBtn.onclick = async () => {
  /* If event exists → real install flow, else fallback help */
  if (deferredPrompt) {
    try{
      deferredPrompt.prompt();
      const res = await deferredPrompt.userChoice;
      if(res.outcome!=='accepted')
        alert('App install was dismissed – you can install later from your browser menu.');
      deferredPrompt = null;
    }catch(err){ logError('install',err); }
  } else {
    alert('Use your browser’s “Add to Home Screen / Install App” option.');
  }
};

/*────────────────────────────────────
  DATA UPLOAD / BACKUP  (GitHub)
────────────────────────────────────*/
const GH_REPO   = 'suhedges/VentX';
const GH_BRANCH = 'main';

/* Get / cache a PAT – clears if 401 later */
async function getToken(){
  if(HARD_TOKEN?.trim()) return HARD_TOKEN.trim();

  let token = localStorage.getItem('gh_token');
  if(token) return token.trim();

  token = prompt('GitHub Personal Access Token (classic) with “repo” scope.\nIt is stored only in this browser.');
  if(token){ localStorage.setItem('gh_token', token.trim()); return token.trim(); }
  return null;
}

/* Generic helper – clears bad tokens automatically */
async function ghRequest(path, opts={}){
  const token = await getToken();
  if(!token) throw new Error('GitHub token required.');
  const res = await fetch(`https://api.github.com${path}`,{
    headers:{
      Authorization:`token ${token}`,
      Accept:'application/vnd.github+json'
    }, ...opts
  });
  if(res.status===401){                 // bad creds → purge and re-prompt next time
    localStorage.removeItem('gh_token');
    throw new Error('GitHub token unauthorized (401). Token has been cleared – try again with a valid one.');
  }
  if(res.ok) return res.json();
  if(res.status===404) return null;
  throw new Error(`GitHub ${res.status}: ${await res.text()}`);
}

/* ---------- RESTORE (single user) ---------- */
async function restoreUserFromGitHub(name){
  try{
    const path  = `backups/${name}.json`;
    const file  = await ghRequest(`/repos/${GH_REPO}/contents/${path}?ref=${GH_BRANCH}`);
    if(!file) return false;                          // nothing there → not existing

    const json  = JSON.parse(decodeURIComponent(escape(atob(file.content))));
    if(!json.data) throw new Error('Invalid backup format');

    /* Ensure unique user */
    if(!(await db.get('users',name))) await db.put('users',{name});

    const tx   = db.transaction(['warehouses','items'],'readwrite');
    const wSto = tx.objectStore('warehouses');
    const iSto = tx.objectStore('items');

    /* wipe any local data for that user first */
    for(const w of await wSto.getAll()) if(w.user===name) await wSto.delete(w.id);
    for(const it of await iSto.getAll()) if(it.whId && it.user===name) await iSto.delete(it.key);

    /* restore */
    for(const bw of json.data){
      await wSto.put({...bw,user:name});
      for(const it of bw.items) await iSto.put(it);
    }
    await tx.done;
    return true;
  }catch(err){ logError('restore',err); alert(err.message); return false; }
}

/* ---------- UPLOAD ---------- */
async function uploadBackup(){
  try{
    const warehouses = (await db.getAll('warehouses')).filter(w=>w.user===user);
    const items      = await db.getAll('items');
    const payload = {
      appVersion : APP_VERSION,
      timestamp  : Date.now(),
      user,
      data : warehouses.map(w=>({...w, items: items.filter(i=>i.whId===w.id)}))
    };
    const content   = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    const path      = `backups/${user}.json`;
    const f = await ghRequest(`/repos/${GH_REPO}/contents/${path}?ref=${GH_BRANCH}`);
    const sha = f?.sha || null;
    await ghRequest(`/repos/${GH_REPO}/contents/${path}`,{
      method:'PUT',
      body:JSON.stringify({
        message:`VentX backup for ${user} @ ${new Date().toISOString()}`,
        content, branch:GH_BRANCH, ...(sha && {sha})
      })
    });
    alert('Backup uploaded to GitHub successfully.');
  }catch(err){ logError('uploadBackup',err); alert('Upload failed → '+err.message); }
}
uploadBtn.onclick = uploadBackup;
uploadBtnWH.onclick = uploadBackup;

/* ---------- DOWNLOAD (overwrite current user) ---------- */
async function downloadBackup(){
  if(!confirm('This will OVERWRITE your current data with the GitHub backup. Continue?')) return;
  const ok = await restoreUserFromGitHub(user);
  if(ok){ alert('Backup restored. Reloading…'); location.reload(); }
}
downloadBtn.onclick = downloadBackup;

/*────────────────────────────────────
  LOGIN  (username only)   – now auto‑restore
────────────────────────────────────*/
loginForm.onsubmit = async e=>{
  e.preventDefault();
  const name = l_user.value.trim();
  if(!name){ alert('Username required'); return; }

  try{
    let rec = await db.get('users', name);
    if(!rec){
      /* try GitHub */
      const restored = await restoreUserFromGitHub(name);
      if(restored) rec = {name};
    }

    if(rec){
      user = name;
      await loadWarehouses();
      show('wh');
    }else{
      if(confirm('User not found on device or GitHub. Create new user?')){
        await db.put('users',{name});
        user = name;
        await loadWarehouses();
        show('wh');
      }else{
        alert('Invalid user');
      }
    }
  }catch(err){ logError('login',err) }
};

/* Add / Remove user helpers */
addUserBtn.onclick = async ()=>{
  const uname = prompt('Enter new username:')?.trim();
  if(!uname) return;
  if(await db.get('users',uname)){ alert('User already exists'); return; }
  await db.put('users',{name:uname});
  alert('User added.');
};

delUserBtn.onclick = async ()=>{
  const uname = prompt('Enter username to delete:')?.trim();
  if(!uname) return;
  if(!(await db.get('users',uname))){ alert('User does not exist'); return; }
  if(!confirm(`Delete user "${uname}" and all associated data? This cannot be undone.`)) return;
  await db.delete('users',uname);
  const whs = await db.getAll('warehouses');
  for(const w of whs.filter(w=>w.user===uname)){
    await db.delete('warehouses',w.id);
    const items = await db.getAll('items');
    for(const it of items.filter(it=>it.whId===w.id))
      await db.delete('items',it.key);
  }
  alert('User removed.');
};

/*────────────────────────────────────
  WAREHOUSES
────────────────────────────────────*/
async function loadWarehouses(){
  const all=await db.getAll('warehouses');
  const mine=all.filter(w=>w.user===user);
  whList.innerHTML = mine.length
    ? mine.map(w=>`
        <li data-wh="${w.id}">
          <span>${w.name}</span>
          <div class="actions">
            <button class="pri" onclick="openWh(${w.id},'${w.name.replace(/'/g,'&#39;')}')">Open</button>
            <button class="sec" onclick="delWh(${w.id})" title="Delete"><img src="trash-solid.svg" alt=""></button>
          </div>
        </li>`).join('')
    : '<li style="justify-content:center;color:#666">No warehouses yet</li>';
}
window.openWh=(id,name)=>{whId=id;whName=name;render();show('main');};

addWh.onclick=async()=>{
  const n=prompt('Warehouse name?'); if(!n) return;
  const id=await db.add('warehouses',{name:n,user,version:0,created:Date.now()});
  openWh(id,n);
};

window.delWh = async id=>{
  if(!confirm('Delete this warehouse and ALL its items?')) return;
  const tx = db.transaction(['warehouses','items'],'readwrite');
  await tx.objectStore('warehouses').delete(id);
  const idx=tx.objectStore('items');
  for(const it of await idx.getAll()) if(it.whId===id) await idx.delete(it.key);
  await tx.done;
  if(id===whId) show('wh');
  await loadWarehouses();
};

/*────────────────────────────────────
  ITEM HELPERS
────────────────────────────────────*/
const key       = partId => `${whId}|${partId}`;
const getAll    = () => db.getAll('items').then(a=>a.filter(i=>i.whId===whId));
const saveItem  = async o =>{
  o.key=key(o.internal);
  o.whId=whId;
  o.modified=Date.now();
  await db.put('items',o);
  const w=await db.get('warehouses',whId);
  if(w){w.version=(w.version||0)+1;w.modified=Date.now();await db.put('warehouses',w);}  
};
const delItem   = async partId=>{
  await db.delete('items',key(partId));
  const w=await db.get('warehouses',whId);
  if(w){w.version=(w.version||0)+1;w.modified=Date.now();await db.put('warehouses',w);}
};
const byUPC     = u => db.getAll('items').then(a=>a.find(i=>i.whId===whId && i.upc===u));

/*────────────────────────────────────
  RENDER LIST
────────────────────────────────────*/
function cmp(a,b,field){
  const numFields=['min','max','qty'];
  const av=a[field] ?? '', bv=b[field] ?? '';
  return numFields.includes(field) ? (av-bv) :
    String(av).localeCompare(String(bv),undefined,{numeric:true});
}
async function render (){
  let list = await getAll();

  /* search term */
  const term = searchInput.value.trim().toLowerCase();
  if (term) {
    list = list.filter(i =>
      i.internal.toLowerCase().includes(term) ||
      i.custom?.toLowerCase().includes(term)  ||
      i.bin?.toLowerCase().includes(term)
    );
  }

  /* below‑min filter */
  if(belowToggle.checked) list = list.filter(i => (i.qty??0) <= (i.min??0));

  list.sort((a,b)=> cmp(a,b,sortField) * (sortDir==='asc'?1:-1));
  itemsBody.innerHTML = list.map(i => `
    <tr data-part="${i.internal.replace(/"/g,'&quot;')}">
      <td class="chk"><input type="checkbox" class="selRow"></td>
      <td data-key="internal">${i.internal}</td>
      <td data-key="custom">${i.custom||''}</td>
      <td data-key="upc">${i.upc||''}</td>
      <td data-key="min">${i.min}</td>
      <td data-key="max">${i.max}</td>
      <td class="qty" data-key="qty">${i.qty}</td>
      <td data-key="bin">${i.bin||''}</td>
      <td class="chk"><img src="trash-solid.svg" class="row-del" title="Delete"></td>
    </tr>`).join('');
  count.textContent = `${whName} \u00B7 ${list.length} items`;
  for(const tr of itemsBody.querySelectorAll('tr')){
    const part=tr.dataset.part;
    tr.querySelector('.selRow').checked=selectedParts.has(part);
  }
  updateBulkUI();
}

/*────────────────────────────────────
  SELECTION / BULK DELETE
────────────────────────────────────*/
function updateBulkUI(){
  delSel.style.display = selectedParts.size ? '' : 'none';
  selectAll.checked = !!selectedParts.size &&
                      selectedParts.size === itemsBody.querySelectorAll('.selRow').length;
}
itemsBody.addEventListener('change', e=>{
  const cb=e.target.closest('.selRow'); if(!cb) return;
  const part=cb.closest('tr').dataset.part;
  cb.checked ? selectedParts.add(part) : selectedParts.delete(part);
  updateBulkUI();
});
selectAll.addEventListener('change', ()=>{
  const all=itemsBody.querySelectorAll('.selRow');
  selectedParts.clear();
  all.forEach(cb=>{
    cb.checked=selectAll.checked;
    if(cb.checked) selectedParts.add(cb.closest('tr').dataset.part);
  });
  updateBulkUI();
});
delSel.onclick = async ()=>{
  if(!confirm(`Delete ${selectedParts.size} selected items?`)) return;
  for(const part of selectedParts) await delItem(part);
  selectedParts.clear();
  render();
};

/* row trash icon */
itemsBody.addEventListener('click', async e=>{
  const del = e.target.closest('.row-del');
  if(del){
    const tr=del.closest('tr'); const part=tr.dataset.part;
    if(confirm(`Delete ${part}?`)){ await delItem(part); render(); }
    return;
  }
});

/*────────────────────────────────────
  TABLE CELL INTERACTIONS
────────────────────────────────────*/
function startQtyEdit(td){
  if(td.isContentEditable) return;
  td.contentEditable='true';
  td.focus();
  document.execCommand?.('selectAll',false,null);
  td.dataset.orig=td.textContent.trim();
}

itemsBody.addEventListener('click', e=>{
  const td=e.target.closest('td'); if(!td) return;
  const field=td.dataset.key;
  const partId=td.parentElement.dataset.part;
  if(field==='qty'){ startQtyEdit(td); }
  else if(!e.target.closest('input') && !e.target.closest('img')) { edit(partId); }
});

/* save qty on blur */
itemsBody.addEventListener('blur', async e=>{
  const td=e.target.closest('td');
  if(!td || td.dataset.key!=='qty') return;
  const val=parseInt(td.textContent.trim(),10);
  const partId=td.parentElement.dataset.part;
  if(!isNaN(val)){
    const it=await db.get('items',key(partId));
    if(it){ it.qty=val; await saveItem(it); }
    td.textContent=val;
  }else td.textContent=td.dataset.orig||0;
  td.removeAttribute('contenteditable');
},true);

/* commit qty on Enter */
itemsBody.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const td=e.target.closest('td');
    if(td && td.dataset.key==='qty'){ e.preventDefault(); td.blur(); }
  }
});

/*────────────────────────────────────
  SEARCH & TOGGLE
────────────────────────────────────*/
searchInput.addEventListener('input', render);
belowToggle.addEventListener('change', render);

/*────────────────────────────────────
  EXPORT  (CSV)
────────────────────────────────────*/
exportBtn.onclick = ()=>exportDlg.showModal();
expCancel.onclick = ()=>exportDlg.close();

async function exportCSV(onlyLow){
  let items = await getAll();
  if(onlyLow) items = items.filter(i => (i.qty??0) <= (i.min??0));
  const header = ['Internal Part','Custom Part','UPC','Qty','Min','Max','Bin'];
  const csvLines = [header.join(',')];
  const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
  for(const i of items){
    csvLines.push([i.internal,i.custom,i.upc,i.qty,i.min,i.max,i.bin].map(esc).join(','));
  }
  const blob = new Blob([csvLines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = onlyLow ? 'inventory_below_min.csv' : 'inventory_all.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
}

expAll.onclick = ()=>{ exportCSV(false); exportDlg.close(); };
expLow.onclick = ()=>{ exportCSV(true);  exportDlg.close(); };

/*────────────────────────────────────
  PRODUCT MANAGER
────────────────────────────────────*/
function openManager(it={}){
  current = it;
  hdr.textContent = it.internal || 'Add Item';
  p_internal.value = it.internal||'';  p_custom.value = it.custom||'';  p_upc.value = it.upc||'';
  p_qty.value = it.qty ?? 0; p_min.value = it.min ?? 0; p_max.value = it.max ?? 0; p_bin.value = it.bin||'';
  prodDlg.showModal();
}

window.edit = async partId => {
  const it = await db.get('items', key(partId));
  if (it) openManager(it);
};

prodForm.onsubmit = async e=>{
  e.preventDefault();
  current = {
    internal : p_internal.value.trim(),
    custom   : p_custom.value.trim(),
    upc      : p_upc.value.trim(),
    qty      : +p_qty.value||0,
    min      : +p_min.value||0,
    max      : +p_max.value||0,
    bin      : p_bin.value.trim()
  };
  try{
    await saveItem(current);
    prodDlg.close(); render();
  }catch(err){logError('saveItem',err)}
};
closeProd.onclick = ()=>prodDlg.close();

/*────────────────────────────────────
  MASS UPC LOGIC
────────────────────────────────────*/
async function prepareMassList(){
  let list = await getAll();
  const term = searchInput.value.trim().toLowerCase();
  if (term) {
    list = list.filter(i =>
      i.internal.toLowerCase().includes(term) ||
      i.custom?.toLowerCase().includes(term)  ||
      i.bin?.toLowerCase().includes(term)
    );
  }
  if(belowToggle.checked) list = list.filter(i => (i.qty??0) <= (i.min??0));
  list.sort((a,b)=> cmp(a,b,sortField) * (sortDir==='asc'?1:-1));
  return list.filter(i=>!i.upc);
}
async function startMassUPC(){
  massList = await prepareMassList();
  if(!massList.length){ alert('All visible items already have UPCs'); return; }
  massMode = true; massIndex = 0; showNextMassItem(); startScan();
}
function showNextMassItem(){
  if(massIndex>=massList.length){ scanInfo.textContent=''; return; }
  const it = massList[massIndex];
  scanInfo.textContent = `${it.internal}  |  BIN: ${it.bin||''}`;
}
massUPCBtn.onclick = startMassUPC;

/*────────────────────────────────────
  BARCODE SCANNER (ZXing)
────────────────────────────────────*/
const ZXING_HINTS = new Map([
  [DecodeHintType.POSSIBLE_FORMATS, [
    BarcodeFormat.UPC_A,  BarcodeFormat.UPC_E,
    BarcodeFormat.EAN_13, BarcodeFormat.EAN_8,
    BarcodeFormat.CODE_128, BarcodeFormat.CODE_39
  ]],
  [DecodeHintType.TRY_HARDER, true],
  [DecodeHintType.ALSO_INVERTED, true]   
]);

const SCAN_CONSTRAINTS = {
  video:{
    facingMode:{ideal:'environment'},
    width     :{ideal:1920},       
    height    :{ideal:1080}
  }
};

let reader, stream, captureInto = null;
let autoFocusInterval = null;       // ★ autofocus

/* UI helpers */
fab.onclick        = () => startScan();
btnUPC.onclick     = () => { captureInto = p_upc; prodDlg.close(); startScan(); };
scanCancel.onclick = () => { massMode = false; stopScan(); };

/* ––––––––– main entry ––––––––– */
async function startScan () {
  scanDlg.showModal();

  try {
    stream = await navigator.mediaDevices.getUserMedia(SCAN_CONSTRAINTS);
    cam.srcObject = stream;
    await cam.play();

    const track = stream.getVideoTracks()[0];
    await applyAutoFocus(track);          // ★ lens → continuous / single‑shot loop
    maybeAddTorch(track);                 // show torch button if possible
    enableTapFocus(track);                // click to refocus

    if ('BarcodeDetector' in window) {
      startNativeDetector(track);
    } else {
      startZXingDetector();
    }
  } catch (err) {
    alert(err.message || err);
    stopScan();
    logError('scan', err);
  }
}

/* ––––––––– autofocus helpers ––––––––– */
async function applyAutoFocus (track) {
  const caps = track.getCapabilities?.() || {};
  const modes = caps.focusMode || [];
  try {
    if (modes.includes('continuous')) {
      await track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
    } else if (modes.includes('single-shot')) {
      await track.applyConstraints({ advanced: [{ focusMode: 'single-shot' }] });
    }

    /* If focus distance is supported, bias toward the nearest end for close‑ups */
    if (caps.focusDistance && typeof caps.focusDistance.min === 'number') {
      await track.applyConstraints({
        advanced: [{ focusDistance: caps.focusDistance.min }]
      });
    }
  } catch {/* ignore unsupported */}
  
  /* ★ Kick single‑shot every 1.5 s (many phones need this nudge) */
  if (modes.includes('single-shot')) {
    autoFocusInterval = setInterval(async () => {
      try {
        await track.applyConstraints({ advanced: [{ focusMode: 'single-shot' }] });
      } catch { /* ignore */ }
    }, 1500);
  }
}

function enableTapFocus (track) {
  const caps = track.getCapabilities?.() || {};
  if (!caps.pointsOfInterest) return;

  cam.onclick = async e => {
    const r = cam.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width;
    const y = (e.clientY - r.top)  / r.height;
    try {
      await track.applyConstraints({
        advanced: [
          { pointsOfInterest: [{ x, y }] },
          { focusMode: caps.focusMode?.includes('single-shot') ? 'single-shot' : 'continuous' }
        ]
      });
    } catch { /* ignore */ }
  };
}

function maybeAddTorch (track) {
  const caps = track.getCapabilities?.() || {};
  if (!caps.torch) return;
  const btn = document.createElement('button');
  btn.id = 'torchBtn';
  btn.textContent = '💡';
  btn.className = 'sec';
  btn.style.position = 'absolute';
  btn.style.top = '1rem';
  btn.style.right = '1rem';
  scanDlg.appendChild(btn);
  btn.onclick = async () => {
    const on = !(btn.dataset.on === '1');
    await track.applyConstraints({ advanced: [{ torch: on }] });
    btn.dataset.on = on ? '1' : '0';
  };
}

/* ––––––––– native detector ––––––––– */
function startNativeDetector (track) {
  const detector = new BarcodeDetector({
    formats: ['upc_a', 'upc_e', 'ean_13', 'ean_8', 'code_128', 'code_39']
  });
  const capture = new ImageCapture(track);

  const loop = async () => {
    if (!scanDlg.open) return;
    try {
      const bmp = await capture.grabFrame();
      const codes = await detector.detect(bmp);
      if (codes.length) return onCode(codes[0].rawValue);
    } catch { /* keep looping */ }
    requestAnimationFrame(loop);
  };
  loop();
}

/* ––––––––– ZXing fallback ––––––––– */
function startZXingDetector () {
  reader = new BrowserMultiFormatReader(ZXING_HINTS, 200);
  reader.decodeFromConstraints(SCAN_CONSTRAINTS, cam, (result, err) => {
    if (result) onCode(result.getText());
  });
}

/* ––––––––– common helpers ––––––––– */
function stopScan () {
  reader?.reset?.();
  stream?.getTracks().forEach(t => t.stop());
  clearInterval(autoFocusInterval); autoFocusInterval=null;   // ★ clear loop
  scanDlg.close();
  document.getElementById('torchBtn')?.remove();
}

/*────────────  HANDLING SCAN RESULT  ────────────*/
async function onCode (code) {
  // Existing logic unchanged…
  if (captureInto) {
    captureInto.value = code;
    captureInto = null;
    stopScan();
    prodDlg.showModal();
    return;
  }

  if (massMode) {
    const it = massList[massIndex];
    it.upc = code;
    await saveItem(it);
    massIndex++;
    if (massIndex < massList.length) {
      showNextMassItem();
    } else {
      massMode = false;
      alert('Mass UPC complete!');
      stopScan();
      render();
    }
    return;
  }

  const existing = await byUPC(code);
  if (existing) {
    alert(`UPC already exists on ${existing.internal}`);
    stopScan();
    return;
  }

  p_upc.value = code;
  stopScan();
  prodDlg.showModal();
}
/*────────────────────────────────────
  IMPORT CSV / XLSX
────────────────────────────────────*/
impBtn.onclick = ()=>importFile.click();
importFile.onchange = async e=>{
  const file=e.target.files[0]; if(!file) return;
  const ext=file.name.split('.').pop().toLowerCase(); let rows=[];
  try{
    if(ext==='csv'){
      const txt=await file.text();
      const Papa=(await import('https://cdn.jsdelivr.net/npm/papaparse@5/+esm')).default;
      rows=Papa.parse(txt,{header:true}).data;
    }else{
      const buf=await file.arrayBuffer();
      const XLSX=(await import('https://cdn.jsdelivr.net/npm/xlsx@0.20.3/+esm')).default;
      const wb=XLSX.read(buf,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      rows=XLSX.utils.sheet_to_json(ws);
    }
    for(const r of rows){
      const internal=String(r['Internal Part']||r.internal||r.Internal||'').trim();
      if(!internal) continue;
      const exists=await db.get('items',key(internal));
      if(exists && !confirm(`${internal} exists. Overwrite?`)) continue;
      await saveItem({
        internal, custom:String(r['Custom Part']||r.custom||r.Custom||'').trim(),
        upc:String(r.UPC||r.upc||'').trim(), qty:exists?exists.qty:0,
        min:+(r.Min||r.min||0), max:+(r.Max||r.max||0), bin:String(r.Bin||r.bin||'').trim()
      });
    }
    render(); importFile.value='';
  }catch(err){logError('import',err)}
};

/*────────────────────────────────────
  CSV TEMPLATE
────────────────────────────────────*/
tmplBtn.onclick = ()=>{
  const csv=['Internal Part','Custom Part','UPC','Min','Max','Bin'].join(',')+'\n';
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='import_template.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/*────────────────────────────────────
  NAVIGATION
────────────────────────────────────*/
backWh.onclick=()=>{ show('wh'); loadWarehouses(); };

/*────────────────────────────────────
  SERVICE-WORKER
────────────────────────────────────*/
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

</script>
</body>
</html>
